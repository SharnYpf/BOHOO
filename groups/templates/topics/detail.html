{% extends 'base.html' %}
{% load avatar_tags %}

{% block head_other %}
    <style type="text/css">
        .right-list {
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0 10px 0;
        }
        .topic{
            margin-bottom: 40px;
        }
        .content{
            margin: 10px !important;
        }
        .reply-content{
            height: auto;
            margin-top: 10px;
        }
        .reply{
            float: right;
            margin-right: 20px;
        }
        .reply-quote{
            padding-left: 10px;
            margin-top: 15px;
        }
        .bg_reply{
            background-color: #e6e6e6;
        }
        .btn_submit{
            margin-right: 20px;
        }
        #id_content{
            height: 100px;
        }
    </style>
{% endblock %}

{% block main %}
    <div class="container-fluid content">
        <div class="row-fluid">
            <div class="span12">
                <h3 class="pull-left">{{ topic.name }}</h3>
            </div>
        </div>

        <div class="row-fluid">
            <div class="span8">
                <div class="row-fluid topic">
                    <div class="span2">{% avatar topic.creator 70 %}</div>
                    <div class="span10">
                        <div class="row-fluid">
                            <span class="items span12 ">
                                <span class="muted">来自:</span>
                                <span class="text-success"><a href="">{{ topic.creator }}</a></span>
                                <span class="text-success">{{ topic.create_time|date:"Y-m-j H:i:s" }}</span>
                                <span class="reply">
                                    <a href="#" class="reply-topic">
                                        <img src="{{ STATIC_URL }}image/reply.png" alt="Reply" align="absmiddle">
                                    </a>
                                </span>
                            </span>
                        </div>
                        <div class="row-fluid">
                            <div class="span12">
                                {% for i in topic.image.all %}
                                    <div><img src="{{ i.get_topic_image_url }}" style="width: 90%;margin-bottom: 20px"></div>
                                {% endfor %}
                                <div>{{ topic.content }}</div>
                            </div>
                            {% if request.user == topic.creator or request.user in topic.group.manager.all %}
                            <div class="span12">
                                <a href="{% url 'edit_topic' group_id=topic.group.id topic_id=topic.id %}" class="btn btn-link pull-right">修改</a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% for r in replies %}
                    <div class="row-fluid">
                        <div class="span1 reply_avatar"><a href="">{% avatar r.creator 55 %}</a></div>
                        <div class="span11 reply-content">
                            <div class="row-fluid">
                                <div class="span12 bg_reply">
                                    <span class="text-success"><a href="">{{ r.creator }}</a></span>
                                    <span class="text-success">{{ r.create_time|date:"Y-m-j H:i:s" }}</span>
                                    <span class="reply">
                                        <a href="#" class="reply-reply" data-reply_id="{{ r.id }}">
                                            <img src="{{ STATIC_URL }}image/reply.png" alt="Reply" align="absmiddle">
                                        </a>
                                    </span>
                                </div>
                            </div>
                            {% if r.reply %}
                                <div class="row-fluid">
                                    <div class="span12 muted reply-quote">
                                        <blockquote>{{ r.reply.content }}<span>&nbsp;&nbsp;@<a href="">{{ r.reply.creator }}</a></span></blockquote>
                                    </div>
                                </div>
                            {% endif %}
                            <div class="row-fluid">
                                <div class="span12">{{ r.content }}</div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                <div class="row-fluid">
                    <form method="post">
                        <div class="span12">
                            {{ form.reply_id }}
                            {{ form.content }}
                        </div>
                        <div class="span12">
                            {% csrf_token %}
                            <input class="btn btn-primary btn-small pull-right btn_submit" type="submit" value="回复"/>
                        </div>
                    </form>

                </div>
            </div>

           <!-- 右边栏 -->
            <div class="span4">
                <div class="row-fluid">
                    <div class="span12"><span class="muted">返回</span><a href="{% url 'group_detail' group_id=topic.group.id %}">{{ topic.group.name }}</a></div>
                </div>
                <div class="row-fluid">
                    <div class="span12">
                        {% if is_member %}
                        <span class="muted">我是群组成员</span>
                        {% else %}
                            {% if topic.group.group_type == 'open' %}
                                <button id="join_group" class="btn btn-primary" data-group-id={{ g.id }}>加入群组</button>
                            {% elif topic.group.group_type == 'private' %}
                                <!-- button to tigger modal -->
                                <button id="apply_join_modal_trigger" class="btn btn-primary">申请加入群组</button>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                <div class="row-fluid">
                    <div class="span12">
                        {% if is_manager %}
                            <span class="muted">我是管理员</span>
                        {% elif is_member %}
                            <button id="apply_be_manager_modal_trigger" class="btn btn-primary">申请成为组长</button>
                        {% endif %}
                    </div>
                </div>
                <div class="row-fluid">
                    <div class="span12">
                        <table class="table">
                            <caption class="pull-left">最新话题<a href="">(更多)</a></caption>
                            <tbody>
                            {% for t in recent_topics %}
                                <tr>
                                <td><a href="{% url 'topic_detail' topic_id=t.id %}">{{ t.name }}</a>
                                    <span class="muted"><small>({{ t.creator }})</small></span>
                                </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- modal for apply reason -->
    <div class="modal hide fade" id="apply_join_group_modal">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h3>理由</h3>
        </div>
        <div class="modal-body">
            <textarea id="apply_reason" placeholder="不说几句很难通过申请哦......"></textarea>
        </div>
        <div class="modal-footer">
            <button id="apply_modal_close" class="btn">取消</button>
            <button id="apply_join_group" class="btn btn-primary" data-group-id={{ g.id }}>发送请求</button>
        </div>
    </div>

    <!-- modal for apply be manager reason -->
    <div class="modal hide fade" id="apply_be_manager_modal">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h3>理由</h3>
        </div>
        <div class="modal-body">
            <textarea id="apply_be_manager_reason" placeholder="不说几句很难通过申请哦......"></textarea>
        </div>
        <div class="modal-footer">
            <button id="apply_be_manager_modal_close" class="btn">取消</button>
            <button id="apply_be_manager" class="btn btn-primary" data-group-id={{ g.id }}>发送请求</button>
        </div>
    </div>
{% endblock %}


{% block js_other %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/join_group_detail.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.scrollTo.min.js"></script>
    <script type="text/javascript">
        // 对话题回复
        $('.reply-topic').click(function(e){
            e.preventDefault();
            $('body').scrollTo("#id_content");
        });
        // 对回复的回复
        $('.reply-reply').click(function(e){
            e.preventDefault();
            $('body').scrollTo("#id_content");
            $('#id_reply_id').val($(this).data('reply_id'));
        });
        $(document).ready(function () {
            // 当前用户是否已经是该小组成员
            {% if is_member %}
                $("#join_group").removeClass("btn-primary").addClass("disabled").attr('disabled', true);
                $("#apply_join_group").removeClass("btn-primary").addClass("disabled").attr('disabled', true);
            {% else %}
                $("#quit_group").removeClass("btn-primary").addClass("disabled").attr('disabled', true);
            {% endif %}

            // 当前用户的申请加入该群组的请求是否正在处理中
            {% if g.group_type == "private" and is_member_processing %}
                $("#apply_join_modal_trigger").html("加入群组...").removeClass("btn-primary").addClass("disabled").attr('disabled', true);
            {% endif %}

            {% if is_manager_processing %}
                $("#apply_be_manager_modal_trigger").html("申请管理员...").removeClass("btn-primary").addClass("disabled").attr('disabled', true);
            {% endif %}

            //  点击打开申请加入群组modal
            $("#apply_join_modal_trigger").click(function(){
                $("#apply_join_group_modal").modal("show");
            });
            // 点击'取消'关闭申请加入群组modal
            $("#apply_modal_close").click(function(){
                $("#apply_join_group_modal").modal("hide");
            });

            // 点击打开申请成为管理员modal
            $("#apply_be_manager_modal_trigger").click(function(){
                $("#apply_be_manager_modal").modal("show");
            });
            // 点击'取消'关闭申请成为管理员modal
            $("#apply_be_manager_modal_close").click(function(){
                $("#apply_be_manager_modal").modal("hide");
            });
        })
    </script>
{% endblock %}