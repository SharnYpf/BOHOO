{% extends 'detail_base.html' %}
{% load compress %}
{% load group_avatar_tags group_tags %}

{% block title %}{{ g.name }}--详情{% endblock %}

{% block head_other %}
    {% compress css %}
    <style type="text/css">
    .left_content{
        margin: 10px 0 10px 0;
    }
    .left-list{
        border: 1px solid #ddd;
        border-radius: 5px;
        margin: 10px 0 10px 0;
    }
{#    .box{#}
{#        margin: 0 0 25px;#}
{#        clear: both;#}
{#        border-radius: 4px;#}
{#        border: 1px solid #ddd;#}
{#        box-shadow: 0 1px 0 #f2f4f5;#}
{#    }#}
{#    .box-module{#}
{#        position: relative;#}
{#        padding: 20px 12px;#}
{#    }#}
    .avatar img{
        padding-left: 15px;
    }
    #apply_reason, #apply_be_manager_reason{
        width: 98%;
    }
    </style>
    {% endcompress %}
{% endblock %}

{% block left_content %}
    <div class="container-fluid left_content">
        <div class="row-fluid box">
            <div class="box-module">
                <div class="row-fluid">
                    <div class="span2 avatar">
                        <div class="row-fluid">
                             <a href="">{% group_avatar g 50 %}</a>
                        </div>
                    </div>
                    <div class="span10">
                        <div class="row-fluid">
                            <div class="span4 text-info">{{ g.name }}</div>
                            <div class="span8">
                                {% if not is_member %}
                                    {% if g.group_type == 'open' %}
                                        <button id="join_group" class="btn btn-primary" data-group-id={{ g.id }}>加入群组</button>
                                    {% elif g.group_type == 'private' %}
                                        <!-- button to tigger modal -->
                                        <button id="apply_join_modal_trigger" class="btn btn-primary">申请加入群组</button>
                                    {% endif %}
                                {% else %}
                                    <span class="text-warning">我是群组成员 ></span>
                                {% endif %}

                                {% if is_manager %}
                                    <span class="text-warning">我是管理员 ></span>
                                {% else %}
                                    <button id="apply_be_manager_modal_trigger" class="btn btn-primary">成为管理员</button>
                                {% endif %}
                                {% if is_member %}
                                    <button id="quit_group" class="btn btn-danger" data-group-id={{ g.id }}>退出群组</button>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row-fluid">
                            <div class="span12">{{ g.description }}</div>
                        </div>
                    </div>
                </div>
                <div class="row-fluid topic-tab">
                    <ul class="breadcrumb">
                        <li><a href="">最近话题</a><span class="divider">/</span></li>
                        <li><a href="">热门话题</a></li>
                        <li class="pull-right"><a href="{% url 'add_topic' group_id=g.id %}"><i class="icon-plus"></i>发帖</a></li>
                    </ul>
                </div>
                <div class="row-fluid topics">
                    <div class="span12">
                        <table class="table">
                            <thead>
                            <tr>
                                <th>话题</th>
                                <th>创建者</th>
                                <th>回复</th>
                                <th>最后发言</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for t in topics %}
                                <tr>
                                    <td><a href="{% url 'topic_detail' topic_id=t.id %}">{{ t.name }}</a></td>
                                    <td><a href="{% url "profile_view" tid=t.creator.id %}">{{ t.creator }}</a></td>
                                    <td>{{ t.reply_amount }}</td>
                                    <td>{{ t.last_reply_add|date:"m-j H:i:s" }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row-fluid friend-group">
    {# TODO:友情小组 #}
    </div>

    <!-- modal for apply reason -->
    <div class="modal hide fade" id="apply_join_group_modal">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h3>理由</h3>
        </div>
        <div class="modal-body">
            <textarea id="apply_reason" placeholder="不说几句很难通过申请哦......"></textarea>
        </div>
        <div class="modal-footer">
            <button id="apply_modal_close" class="btn">取消</button>
            <button id="apply_join_group" class="btn btn-primary" data-group-id={{ g.id }}>发送请求</button>
        </div>
    </div>

    <!-- modal for apply be manager reason -->
    <div class="modal hide fade" id="apply_be_manager_modal">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h3>理由</h3>
        </div>
        <div class="modal-body">
            <textarea id="apply_be_manager_reason" placeholder="不说几句很难通过申请哦......"></textarea>
        </div>
        <div class="modal-footer">
            <button id="apply_be_manager_modal_close" class="btn">取消</button>
            <button id="apply_be_manager" class="btn btn-primary" data-group-id={{ g.id }}>发送请求</button>
        </div>
    </div>
{% endblock %}

{% block js_other %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/join_group_detail.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/quit_group_detail.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            // 当前用户是否已经是该小组成员
            {% if is_member %}
                $("#join_group").removeClass("btn-primary").addClass("disabled").attr('disabled', true);
                $("#apply_join_group").removeClass("btn-primary").addClass("disabled").attr('disabled', true);
            {% else %}
                $("#quit_group").removeClass("btn-primary").addClass("disabled").attr('disabled', true);
            {% endif %}

            // 当前用户的申请加入该群组的请求是否正在处理中
            {% if g.group_type == "private" and is_member_processing %}
                $("#apply_join_modal_trigger").html("加入群组...").removeClass("btn-primary").addClass("disabled").attr('disabled', true);
            {% endif %}

            {% if is_manager_processing %}
                $("#apply_be_manager_modal_trigger").html("申请管理员...").removeClass("btn-primary").addClass("disabled").attr('disabled', true);
            {% endif %}

            //  点击打开申请加入群组modal
            $("#apply_join_modal_trigger").click(function(){
                $("#apply_join_group_modal").modal("show");
            });
            // 点击'取消'关闭申请加入群组modal
            $("#apply_modal_close").click(function(){
                $("#apply_join_group_modal").modal("hide");
            });

            // 点击打开申请成为管理员modal
            $("#apply_be_manager_modal_trigger").click(function(){
                $("#apply_be_manager_modal").modal("show");
            });
            // 点击'取消'关闭申请成为管理员modal
            $("#apply_be_manager_modal_close").click(function(){
                $("#apply_be_manager_modal").modal("hide");
            });
        })
    </script>
{% endblock %}
