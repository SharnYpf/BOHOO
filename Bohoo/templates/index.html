{% extends "base.html" %}
{% load compress %}
{% load timeformat %}

{% block descrition %}Bohoo首页{% endblock %}
{% block title %}Bohoo首页{% endblock %}

{% block head_other %}
    <style type="text/css">
    .btn-register{
        width: 247px;
    }
    .btn-signup-weibo,.btn-signup-qq{
        width: 222px;
    }
    .btn-signup-weibo{
        margin-bottom: 20px;
    }
    .recent-topic ul li{
        list-style-type: none;
    }
    .table th,.table td{
        text-align: center;
    }
    .table th{
        font-size: 20px !important;
    }
    .nav-list{
        padding: 0 !important;
    }
    .nav-list > li > a{
        padding: 3px 10px !important;
        color: #000000;
    }
    .accordion-toggle{
        font-weight: bolder;
    }
    </style>
{% endblock %}

{% block main %}
    {% if not request.user.is_authenticated %}
    <div class="container-fluid">
        <div class="row-fluid">
            <div class="span8">
                {# 网站功能描述 #}
                <p class="text-info">网站介绍1</p>
                <p class="text-info">网站介绍2</p>
                <p class="text-info">网站介绍3</p>
                <p class="text-info">网站介绍4</p>
                <p class="text-info">网站介绍5</p>
            </div>
            <div class="span4">
                <div class="control-group">
                    <form method="post" id="id_register_form">{% csrf_token %}
                        <div class="input-prepend"><span class="add-on"><i class="icon-envelope"></i></span>{{ form.email }}</div>
                        <div class="input-prepend"><span class="add-on"><i class="icon-user"></i></span>{{ form.username }}</div>
                        <div class="input-prepend"><span class="add-on"><i class="icon-lock"></i></span>{{ form.password }}</div>
                        <div class="input-prepend"><span class="add-on"><i class="icon-lock"></i></span>{{ form.password1 }}</div>
                        <label class="checkbox"><input type="checkbox" id="id_terms">我已经阅读并同意<a href="">服务条款</a> </label>
                        <button class="btn btn-primary btn-register">注册</button>
                    </form>
                        <a href="{% url 'social_weibo_login' %}" class="btn btn-primary btn-signup-weibo">微博帐号注册</a>
                        <a href="{% url 'social_qqweibo_login' %}" class="btn btn-primary btn-signup-qq">qq帐号注册</a>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row pull-left">
            <div class="span8">
                <div class="recent-topic">
                    <ul>
                        {% for t in recent_topics %}
                            <li><a href="{% url 'topic_detail' topic_id=t.id %}">{{ t.name }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% else %}
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span3">
                    <div class="accordion" id="accordion1">
                        {% for c in categories %}
                        <div class="accordion-group">
                            <div class="accordion-heading">
                                <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion1" href="#accordion_{{ forloop.counter0 }}">
                                    {{ c.name }}
                                </a>
                            </div>
                            <div id="accordion_{{ forloop.counter0 }}"  class="accordion-body collapse {% if not forloop.counter0 %}in{% endif %}">
                                <div class="accordion-inner">
                                    <ul class="nav nav-list left-list">
                                        {% for t in c.category_parent.all %}
                                        <li id="c_{{ t.id }}"><a href="{% url 'index' %}?c_id={{ t.id }}&ca={{ forloop.parentloop.counter0 }}">{{ t.name }}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="span9">
                    {% for g in groups %}
                        <table class="table table-hover">
                            <tr>
                                <th colspan="2"><a href="{% url 'group_detail' group_id=g.id %}">{{ g.name }}</a></th>
                            </tr>
                            {% for t in g.get_last_reply_order_topic_qs %}
                                <tr>
                                    <td><a href="{% url 'topic_detail' topic_id=t.id %}">{{ t.name }}</a></td>
                                    <td>{{ t.create_time|date:"m-d H:i:s" }}</td>
                                </tr>
                            {% endfor %}
                        </table>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block js_other %}
    <script type="text/javascript">
        // 给选定的tab加上active
        {% if request.GET.c_id %}
            var c_id = "{{ request.GET.c_id }}";
            $("#c_"+ c_id).addClass("active");
        {% else %}
            $("#c_1").addClass("active");
        {% endif %}

        // 选定的tab的corrdion展开
        {% if request.GET.ca %}
            var ca = "{{ request.GET.ca }}";
            $("#accordion_" + ca).addClass("in");
        {% endif %}

        $('.btn-register').on('click',function(e){
            e.preventDefault();
            if ($('#id_terms').is(':checked')){  // 未同意服务条款不给提交
                var pass_check = true;
                // 验证用户名是否重复
                var username = $('#id_username').val();
                $.globalMessenger()['do']({
                    errorMessage: "服务器错误,请稍后重试!",
                    hideAfter: 2,
                    showCloseButton: true
                },{
                    url:"{% url 'username_check' %}",
                    data: {'username': username},
                    type:'post',
                    async: false,
                    success: function(res){
                        var res = JSON.parse(res);  // 将字符串转化为字典
                        if (res['error'] == 'error'){
                            pass_check = false;
                            return {type:'error', message:"用户名为空或者该用户名已经存在"};
                        }
                        return false;
                    }
                });
                // 验证邮箱格式
                var email = $('#id_email').val();
                if(pass_check){
                    $.globalMessenger()['do']({
                        errorMessage: "服务器错误,请稍后重试!",
                        action: function(){
                            var pattern = new RegExp(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i);
                            if(!pattern.test(email)){
                                pass_check = false;
                                return $.globalMessenger().post({
                                        message:"邮箱为空或者格式错误",
                                        hideAfter: 2,
                                        type: 'error',
                                        showCloseButton: true
                                    });
                            }
                        }
                    });
                }

                // 验证邮箱是否已经被注册
                if(pass_check){
                    $.globalMessenger()['do']({
                        errorMessage: "服务器错误,请稍后重试!",
                        hideAfter: 2,
                        showCloseButton: true
                    },{
                        url:"{% url 'email_check' %}",
                        data: {'email': email},
                        type:'post',
                        async: false,
                        success: function(res){
                            var res = JSON.parse(res);  // 将字符串转化为字典
                            if (res['error'] == 'error'){
                                pass_check = false;
                                console.log('error');
                                return {type:'error', message:" 该邮箱已经被注册"};
                            }
                            return false;
                        }
                    });
                }

                // 验证密码是否一致
                if(pass_check){
                    $.globalMessenger()['do']({
                        errorMessage: "服务器错误,请稍后重试!",
                        action: function(){
                            var password = $('#id_password').val();
                            var password1 = $('#id_password1').val();
                            if (!password.length || !password1.length || password != password1){
                                pass_check = false;
                                return $.globalMessenger().post({
                                        message:"密码为空或者密码不一致",
                                        hideAfter: 2,
                                        type: 'error',
                                        showCloseButton: true
                                    });
                            }
                        }
                    });
                }
                if(pass_check){
                    $('#id_register_form').submit();  // 提交form
                }
            }else{
                $.globalMessenger().post({
                    message: "请阅读并同意服务条款!",
                    hideAfter: 2,
                    type: 'error',
                    showCloseButton: true
                });
                return false;
            }
        });
    </script>
{% endblock %}
